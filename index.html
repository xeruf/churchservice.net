<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test - Gottesdienst in Berlin</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <style>
        html, body {
            height: 100%;
            margin: 0;
        }
        #map { height: 100%; }
    </style>
</head>
<body>
<div id="map"></div>
<input type="text" id="filterbox" oninput="filter(this.value)" placeholder="Finde deinen Gottesdienst..."
style="position: absolute; top: 10px; left: 50px; z-index: 999"/>
</body>
<script>
    const map = L.map('map', {
        center: [52.5, 13.4],
        zoom: 13,
        minZoom: 11,
    })
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)

    const churches = L.featureGroup().addTo(map)
    function createMarker(church) {
        function pos(ar) {
            let data = ar
            while(Array.isArray(data[0])) {
                if(data.length > 2)  {
                    return data.reduce((acc, elem) => {
                        let corner = elem
                        while (Array.isArray(corner[0]))
                            corner = corner[0]
                        return [acc[0] + corner[0], acc[1] + corner[1]]
                    }, [0, 0]).map(value => value / data.length)
                }
                data = data[0]
            }
            return data
        }
        const marker = L.marker(pos(church.geometry.coordinates).reverse(), {
            title: church.properties.name,
            riseOnHover: true
        }).on('click', () => console.log(church))
        const props = church.properties
        marker.properties = props
        function joinFiltered(delim, ...values) {
            return values.filter(it => it !== undefined && it.length > 0).join(delim)
        }
        const content =
            joinFiltered("<br>", props.name && "<b>" + props.name + "</b>",
                props.denomination && "<i>" + props.denomination + "</i>",
                props.service_times && "Gottesdienst: " + props.service_times,
                joinFiltered(" ", props["addr:street"], props["addr:housenumber"]),
                joinFiltered(" ", props["addr:postcode"], props["addr:suburb"] || props["addr:city"]),
            )
        if(content.length > 0) {
            marker.bindPopup(content, {
                maxWidth: 500
            })
        }
        return marker
    }

    const markers = fetch("overpass-export.geojson")
        .then(response => response.json())
        .then(json => json.features
            .filter(church => church.properties.name)
            .map(createMarker))
    filter(document.getElementById("filterbox").value)

    function filter(string) {
        markers.then(markers => {
            churches.clearLayers()
            markers
                .filter(church => !string ||
                    church.properties.name.toLowerCase().includes(string.toLowerCase()))
                .forEach(churches.addLayer.bind(churches))
        })
    }

</script>
</html>