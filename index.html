<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Find Your Church</title>
    <link rel="shortcut icon" href="res/favicon.ico">
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <!-- Leaflet.Markercluster -->
    <script src='https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js'></script>
    <link href='https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css' rel='stylesheet' />
    <link href='https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css' rel='stylesheet' />
    <link rel="stylesheet" href="res/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>
<body>
<div id="filters">
    <input id="search" type="text" autocomplete="off" oninput="filter(this.value)" placeholder="Finde deinen Gottesdienst..."/>
    <!-- <a href="#">filter by service=today -> chain filters </a> -->
</div>
<div id="map"></div>
</body>
<script>
    function updateUrl(newParams) {
        // https://stackoverflow.com/a/65701780
        let newUrl = new URL(window.location.href);
        let params = new URLSearchParams(newUrl.search);
        for(const [key, val] of Object.entries(newParams))
            params.set(key, val)
        newUrl.search = params.toString();
        history.replaceState(null, '', newUrl.toString());
    }

    let newUrl = new URL(window.location.href);
    let params = new URLSearchParams(newUrl.search);

    document.getElementById('search').value = params.get('search')

    const map = L.map('map', {
        center: [params.get('x') || 52.5, params.get('y') || 13.4],
        zoom: params.get('z') || 13,
        minZoom: 2,
    })
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | <a onclick="editOSM()" href="#">Contribute</a>'
    }).addTo(map)
    map.locate({
        setView: true,
        maxZoom: 15,
        maximumAge: 600_000,
    });
    map.on('moveend', (e) => {
        updateUrl({
            x: map.getCenter().lat.toPrecision(7),
            y: map.getCenter().lng.toPrecision(7),
            z: map.getZoom(),
        })
    })

    const churchIcon = L.icon({
        ...L.Icon.Default.prototype.options,
        iconUrl: new URL('res/marker-cross.svg', document.location).href,
        iconRetinaUrl: undefined,
        shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
    });

    const churches = L.markerClusterGroup({
        polygonOptions: { color: '#EE0', fillOpacity: 0.5 }, // https://leafletjs.com/reference.html#path-options
        disableClusteringAtZoom: 13, // 14?
        maxClusterRadius: 60,
        spiderfyOnMaxZoom: false,
    }).addTo(map)
    function createMarker(church) {
        function pos(ar) {
            let data = ar
            while(Array.isArray(data[0])) {
                if(data.length > 2)  {
                    return data.reduce((acc, elem) => {
                        let corner = elem
                        while (Array.isArray(corner[0]))
                            corner = corner[0]
                        return [acc[0] + corner[0], acc[1] + corner[1]]
                    }, [0, 0]).map(value => value / data.length)
                }
                data = data[0]
            }
            return data
        }

        const props = church.properties
        const marker = L.marker(pos(church.geometry.coordinates).reverse(), {
            title: props.name,
            riseOnHover: true,
            icon: churchIcon,
        }).on('click', () => console.log(church))
        marker.properties = props
        marker.properties.searchName = props.name.toString().toLowerCase()
        function joinFiltered(delim, ...values) {
            return values.filter(it => it !== undefined && it.length > 0).join(delim)
        }
        const name = props.name && '<b>' + props.name + '</b>'
        const content =
            joinFiltered('<br>',
                props.website ? `<a target="_blank" href='${props.website}'>${name}</a>` : name,
                props.denomination && '<i>' + props.denomination + '</i>',
                props.service_times && 'Service: ' + props.service_times, // TODO parse properly
                joinFiltered(' ', props['addr:street'], props['addr:housenumber']),
                joinFiltered(' ', props['addr:postcode'], props['addr:suburb'] || props['addr:city']),
            )
        if(content.length > 0) {
            marker.bindPopup(content, {
                maxWidth: 500,
                autoPanPadding: [80, 80],
            })
        }
        return marker
    }

    const markers = fetch('churches-all.geojson')
        .then(response => response.json())
        .then(json => json.features
            .filter(church => church.properties.name)
            .map(createMarker))
        .then(markers => {
            hidden = markers
            filter(document.getElementById('search').value)
        })

    let visible = [];
    let hidden = [];
    function filter(string) {
        updateUrl({ search: string })
        const term = string ? string.toLowerCase() : ''
        const predicate = term.length === 0 ? () => true :
            church => church.properties.searchName.includes(term) ||
                (church.properties.denomination && church.properties.denomination.includes(term))

        const keepVisible = []
        const toHide = []
        visible.forEach(it => {
            if (predicate(it))
                keepVisible.push(it)
            else
                toHide.push(it)
        })
        churches.removeLayers(toHide)

        const keepHidden = []
        const toShow = []
        hidden.forEach(it => {
            if (predicate(it))
                toShow.push(it)
            else
                keepHidden.push(it)
        })
        churches.addLayers(toShow)

        visible = keepVisible.concat(toShow)
        hidden = keepHidden.concat(toHide)
    }

    function editOSM() {
        let zoom = map.getZoom()
        let pos = map.getCenter()
        if(map._popup && map._popup._latlng) {
            zoom = 19
            pos = map._popup._latlng
        }
        window.open(`https://www.openstreetmap.org/edit#map=${zoom}/${pos.lat}/${pos.lng}`, '_blank');
    }
</script>
</html>
