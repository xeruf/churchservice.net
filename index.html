<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Finde deinen Gottesdienst in Berlin - Demo</title>
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>
    <!-- Leaflet.Markercluster -->
    <script src='https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js'></script>
    <link href='https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css' rel='stylesheet' />
    <link href='https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css' rel='stylesheet' />
    <link rel="stylesheet" href="res/style.css" type="text/css"/>
</head>
<body>
<div id="map"></div>
<div id="search"><input type="text" oninput="filter(this.value)" placeholder="Finde deinen Gottesdienst..."/></div>
</body>
<script>
    const map = L.map('map', {
        center: [52.5, 13.4],
        zoom: 13,
        minZoom: 11,
    })
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map)

    const churchIcon = L.icon({
        ...L.Icon.Default.prototype.options,
        iconUrl: new URL('res/marker-cross.png', document.location).href,
        iconRetinaUrl: new URL('res/marker-cross-2x.png', document.location).href,
        shadowUrl: new URL(L.Icon.Default.prototype.options.shadowUrl, L.Icon.Default.prototype._detectIconPath()).href,
    });

    const churches = L.markerClusterGroup({
        disableClusteringAtZoom: 15,
        spiderfyOnMaxZoom: false,
    }).addTo(map)
    function createMarker(church) {
        function pos(ar) {
            let data = ar
            while(Array.isArray(data[0])) {
                if(data.length > 2)  {
                    return data.reduce((acc, elem) => {
                        let corner = elem
                        while (Array.isArray(corner[0]))
                            corner = corner[0]
                        return [acc[0] + corner[0], acc[1] + corner[1]]
                    }, [0, 0]).map(value => value / data.length)
                }
                data = data[0]
            }
            return data
        }
        const marker = L.marker(pos(church.geometry.coordinates).reverse(), {
            title: church.properties.name,
            riseOnHover: true,
            icon: churchIcon,
        }).on('click', () => console.log(church))
        const props = church.properties
        marker.properties = props
        marker.properties.searchName = props.name.toLowerCase()
        function joinFiltered(delim, ...values) {
            return values.filter(it => it !== undefined && it.length > 0).join(delim)
        }
        const content =
            joinFiltered("<br>", props.name && "<b>" + props.name + "</b>",
                props.denomination && "<i>" + props.denomination + "</i>",
                props.service_times && "Gottesdienst: " + props.service_times,
                joinFiltered(" ", props["addr:street"], props["addr:housenumber"]),
                joinFiltered(" ", props["addr:postcode"], props["addr:suburb"] || props["addr:city"]),
            )
        if(content.length > 0) {
            marker.bindPopup(content, {
                maxWidth: 500
            })
        }
        return marker
    }

    const markers = fetch("overpass-export.geojson")
        .then(response => response.json())
        .then(json => json.features
            .filter(church => church.properties.name)
            .map(createMarker))
        .then(markers => {
            hidden = markers
            filter(document.getElementById("search").value)
        })

    let visible = [];
    let hidden = [];
    function filter(string) {
        const term = string ? string.toLowerCase() : ""
        const predicate = term.length === 0 ? () => true :
            church => church.properties.searchName.includes(term)

        const keepVisible = []
        const toHide = []
        visible.forEach(it => {
            if (predicate(it))
                keepVisible.push(it)
            else
                toHide.push(it)
        })
        churches.removeLayers(toHide)

        const keepHidden = []
        const toShow = []
        hidden.forEach(it => {
            if (predicate(it))
                toShow.push(it)
            else
                keepHidden.push(it)
        })
        churches.addLayers(toShow)

        visible = keepVisible.concat(toShow)
        hidden = keepHidden.concat(toHide)
    }

</script>
</html>