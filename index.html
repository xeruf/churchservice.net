<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>UnternehmerLand</title>
    <link rel="shortcut icon" href="res/favicon.ico">
    <!-- Leaflet -->
    <link rel="stylesheet" href="./node_modules/leaflet/dist/leaflet.css"/>
    <script src="./node_modules/leaflet/dist/leaflet.js"/></script>
    <!-- Leaflet.Markercluster -->
    <script src='./node_modules/leaflet.markercluster/dist/leaflet.markercluster.js'></script>
    <link href='./node_modules/leaflet.markercluster/dist/MarkerCluster.css' rel='stylesheet' />
    <link href='./node_modules/leaflet.markercluster/dist/MarkerCluster.Default.css' rel='stylesheet' />

    <script src='./node_modules/overpass-layer/dist/overpass-layer.js'></script>
    <link rel="stylesheet" href="res/style.css" type="text/css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
</head>
<body>
<div class="overlay" id="filters">
    <input class="fontIcon" id="search" type="text" autocomplete="off" oninput="filter(this.value)" placeholder="Filtern..."/>
    <!-- <div id="loaders">
        <button onclick="loadAll()">Globale Daten Laden (ca. 1 GB)</button>
        <button onclick="loadRegister()">Register Laden (ca. 50 MB)</button>
    </div> -->
    <!-- <a href="#">filter by service=today -> chain filters </a> -->
</div>
<div id="map"></div>
<div class="overlay" id="layers">
    <button class="layer-toggle fontIcon" id="cafe" onclick="toggleLayer()">&#127860;</a>
    <button class="layer-toggle fontIcon" id="craft" onclick="toggleLayer()">üî®</a>
    <button class="layer-toggle fontIcon" id="office" onclick="toggleLayer()">üè¢</a>
    <!-- <a href="#">filter by service=today -> chain filters </a> -->
</div>
</body>
<script>
    const maxZoomCluster = 13 // 13-16 depending on density

    function updateUrl(newParams) {
        // https://stackoverflow.com/a/65701780
        let newUrl = new URL(window.location.href);
        let params = new URLSearchParams(newUrl.search);
        for(const [key, val] of Object.entries(newParams))
            params.set(key, val)
        newUrl.search = params.toString();
        history.replaceState(null, '', newUrl.toString());
    }

    let newUrl = new URL(window.location.href);
    let params = new URLSearchParams(newUrl.search);

    document.getElementById('search').value = params.get('search')

    // Berlin const defaultPos = { x: 52.5, y: 13.4, z: 13 }
    const defaultPos = { x: 51, y: 10.5, z: 7 }
    const map = L.map('map', {
        center: [params.get('x') || defaultPos.x, params.get('y') || defaultPos.y],
        zoom: params.get('z') || defaultPos.z,
        minZoom: 2,
    })
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors | <a onclick="editOSM()" href="#">Contribute</a>'
    }).addTo(map)
    params.has('x') || params.has('y') || map.locate({
        setView: true,
        maxZoom: maxZoomCluster,
        maximumAge: 600_000, // 10 minutes
        //timeout: 2000,
        // watch: true, TODO simulate movement and test
        // console.log("Map Moved") map.stopLocate()
    });
    map.on('moveend', (e) => {
        updateUrl({
            x: map.getCenter().lat.toPrecision(7),
            y: map.getCenter().lng.toPrecision(7),
            z: map.getZoom(),
        })
        for(key in overpassLayers) {
            const layer = overpassLayers[key]
            const minZoom = layer.options.minZoom
            if(layer.map && map.getZoom() < minZoom) {
                document.getElementById(key).click()
            }
        }
    })

    const churchIcon = L.icon({
        ...L.Icon.Default.prototype.options,
        iconUrl: new URL('res/marker.svg', document.location).href,
        iconRetinaUrl: undefined,
        shadowUrl: './node_modules/leaflet/dist/images/marker-shadow.png',
    });

    const churches = L.markerClusterGroup({
        polygonOptions: { color: '#EE0', fillOpacity: 0.5 }, // https://leafletjs.com/reference.html#path-options
        disableClusteringAtZoom: maxZoomCluster,
        maxClusterRadius: 70,
        //maxClusterRadius: 100,
        //spiderfyOnMaxZoom: false,
    }).addTo(map)
    function createMarker(church) {
        function pos(ar) {
            let data = ar
            while(Array.isArray(data[0])) {
                if(data.length > 2)  {
                    return data.reduce((acc, elem) => {
                        let corner = elem
                        while (Array.isArray(corner[0]))
                            corner = corner[0]
                        return [acc[0] + corner[0], acc[1] + corner[1]]
                    }, [0, 0]).map(value => value / data.length)
                }
                data = data[0]
            }
            return data
        }

        const props = church.properties || church
        if(!props.name)
            return null
        const coords = church.geometry ? pos(church.geometry.coordinates).reverse() : church.c
        if(coords.length === 0)
            return null
        const marker = L.marker(coords, {
            title: props.name,
            riseOnHover: true,
            icon: churchIcon,
        }).on('click', () => console.log("Selected", church))
        marker.properties = props
        marker.properties.searchName = props.name.toString().toLowerCase()
        function nonBlank(string) {
            return string !== undefined && string.length > 0
        }
        function joinFiltered(delim, ...values) {
            return values.filter(it => nonBlank(it)).join(delim)
        }
        function surround(content, prefix, suffix, condition) {
            return nonBlank(arguments.length > 3 ? condition : content) ? joinFiltered('', prefix, content, suffix) : content
        }
        const name = props.name && '<b>' + props.name + '</b>'
        const content =
            joinFiltered('<br>',
                surround(name, `<a target="_blank" href='${props.website}'>`, '</a>', props.website),
                // Business
                surround(props.craft, "Handwerk: "),
                surround(props.office, "B√ºro: "),
                // Church
                surround(props.denomination, '<i>', '</i>'),
                props.service_times && 'Service: ' + props.service_times, // TODO parse properly
                // Address
                props['addr:street'] && joinFiltered(' ', props['addr:street'], props['addr:housenumber']),
                joinFiltered(' ', props['addr:postcode'], props['addr:suburb'] || props['addr:city']),
                // Extra
                props.id,
            )
        if(content.length > 0) {
            marker.bindPopup(content, {
                maxWidth: 500,
                autoPanPadding: [80, 80],
            })
        }
        return marker
    }

    function loadAll() {
        const button = event.target
        button.disabled = true
        const markers = fetch('osm/planet-220926-craft.geojson')
            .then(response => response.json())
            .then(json => json.features.map(createMarker).filter(marker => marker !== null))
            .then(markers => {
                hidden = markers
                filter(document.getElementById('search').value)
                button.remove()
            })
    }
    function loadRegister(register) {
        if(event) {
            const button = event.target
            button.disabled = true
        }
        const markers = fetch(register)
            .then(response => response.json())
            .then(json => json.map(createMarker).filter(marker => marker !== null))
            .then(markers => {
                hidden = markers
                filter(document.getElementById('search').value)
                if(event) button.remove()
            })
    }
    loadRegister('register.json')

    let visible = [];
    let hidden = [];
    function filter(string) {
        updateUrl({ search: string })
        const term = string ? string.toLowerCase() : ''
        const predicate = term.length === 0 ? () => true :
            church => church.properties.searchName.includes(term) ||
                (church.properties.denomination && church.properties.denomination.includes(term))

        const keepVisible = []
        const toHide = []
        visible.forEach(it => {
            if (predicate(it))
                keepVisible.push(it)
            else
                toHide.push(it)
        })
        churches.removeLayers(toHide)

        const keepHidden = []
        const toShow = []
        hidden.forEach(it => {
            if (predicate(it))
                toShow.push(it)
            else
                keepHidden.push(it)
        })
        churches.addLayers(toShow)

        visible = keepVisible.concat(toShow)
        hidden = keepHidden.concat(toHide)
    }

    function editOSM() {
        let zoom = map.getZoom()
        let pos = map.getCenter()
        if(map._popup && map._popup._latlng) {
            zoom = 19
            pos = map._popup._latlng
        }
        window.open(`https://www.openstreetmap.org/edit#map=${zoom}/${pos.lat}/${pos.lng}`, '_blank');
    }
</script>
<script>
    var overpassFrontend = new OverpassFrontend('//overpass-api.de/api/interpreter')
    const overpassLayers = {
        cafe: new OverpassLayer({
            query: '(node[amenity~"^(restaurant|cafe)$"];way[amenity~"^(restaurant|cafe)$"];);',
            minZoom: 15,
            feature: {
              body: "{{ tags.amenity }}<br/>Cuisine: {{ tags.cuisine|default('unknown') }}",
              style: 'color: transparent; fillColor: transparent',
              markerSymbol: "<img src='res/marker.svg' width='25' height='41' anchorX='15' anchorY='42' signAnchorX='0' signAnchorY='-30'>",
              markerSign: '{% if tags.amenity=="restaurant" %}&#127860;{% elseif tags.amenity=="cafe" %}&#9749;{% endif %}'
            }
        }),
        craft: new OverpassLayer({
            query: 'nwr[craft]',
            minZoom: 13,
            feature: {
              style: 'color: transparent; fillColor: transparent',
              markerSymbol: "<img src='res/marker.svg' width='25' height='41' anchorX='15' anchorY='42' signAnchorX='0' signAnchorY='-30'>",
              markerSign: 'üî®'
            }
        }),
        office: new OverpassLayer({
            query: 'nwr[office]',
            minZoom: 14,
            feature: {
              style: 'color: transparent; fillColor: transparent',
              markerSymbol: "<img src='res/marker.svg' width='25' height='41' anchorX='15' anchorY='42' signAnchorX='0' signAnchorY='-30'>",
              markerSign: 'üè¢'
            }
        }),
    }
    function toggleLayer() {
        const button = event.target
        const key = button.id
        const layer = overpassLayers[key]
        if(button.classList.contains('active')) {
            button.classList.remove('active')
            layer.remove()
        } else {
            button.classList.add('active')
            layer.addTo(map)
            const minZoom = layer.options.minZoom
            if(map.getZoom() < minZoom)
                map.setZoom(minZoom)
        }
    }
</script>
</html>
